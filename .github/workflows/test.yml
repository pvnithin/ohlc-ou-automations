name: TEST RUN - Scraper & Alerts (Skip OHLC)

on:
  workflow_dispatch: # Allows you to manually trigger this from the 'Actions' tab

jobs:
  run-scripts:
    runs-on: ubuntu-latest
    steps:
      # --- 1. SETUP ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install dependencies for Analysis and Scraping
          pip install pandas pyarrow yfinance requests beautifulsoup4 openpyxl xlsxwriter lxml

      - name: Ensure directories exist
        run: |
          mkdir -p data results_all results_selected outputs

      # --- 2. DATA FETCH (SKIPPED FOR TESTING) ---
      # We comment this out so it uses the 'results_all' data you uploaded
      # - name: Run ohlc.py (Fetch Data)
      #   run: python scripts/ohlc.py

      # --- 3. ANALYSIS SCRIPTS ---
      - name: Run oucheck.py (Generate ALL Signals)
        # This re-generates the CSV from your parquet file to ensure freshness
        run: python scripts/oucheck.py

      - name: Run oucheck1.py (Generate SELECTED Signals)
        # Runs for records, but no alerts sent for this one
        run: python scripts/oucheck1.py

      # --- 4. SCRAPING ---
      - name: Run Scraper (Process oucheck.py results)
        # This reads the CSV from results_all and creates the Excel file
        run: python scripts/scraper.py

      # --- 5. TELEGRAM ALERTS (Focused on oucheck.py) ---
      - name: Send Telegram Alerts & Files
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # 1. Identify Files in results_all (output of oucheck.py and scraper.py)
          # We search for the latest files created in this run
          CSV_FILE=$(ls results_all/ou_signals_all_*.csv 2>/dev/null | head -n 1)
          EXCEL_FILE=$(ls results_all/Screener_Analysis_All_*.xlsx 2>/dev/null | head -n 1)
          
          if [ -z "$CSV_FILE" ]; then
            echo "No CSV file found in results_all. Check if oucheck.py ran correctly."
            exit 0
          fi

          TODAY=$(date +'%Y-%m-%d')
          
          # 2. Parse CSV for BUY Signal Text
          # Extracts rows where column 4 is 'BUY'
          BUY_LIST=$(awk -F',' '$4 == "BUY" {printf "â€¢ %s (%.2f)\n", $1, $3}' "$CSV_FILE" | sed 's/\.NS//g')
          BUY_COUNT=$(echo "$BUY_LIST" | grep -c "â€¢" || true)
          
          if [ -z "$BUY_LIST" ] || [ "$BUY_COUNT" -eq 0 ]; then
             MESSAGE=$(printf "ðŸ“‰ *No BUY Signals Today (%s)*" "$TODAY")
          else
             MESSAGE=$(printf "ðŸ“ˆ *BUY Signals Detected (%s)*\n\n%s" "$TODAY" "$BUY_LIST")
          fi
          
          # 3. Send Text Message
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode "text=${MESSAGE}"
            
          # 4. Send The CSV File (From oucheck.py)
          if [ ! -z "$CSV_FILE" ]; then
             echo "Sending CSV: $CSV_FILE"
             curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"$CSV_FILE" \
              -F caption="ðŸ“„ Raw Signal Data (All)"
          fi

          # 5. Send The Excel File (From scraper.py)
          if [ ! -z "$EXCEL_FILE" ]; then
            echo "Sending Excel: $EXCEL_FILE"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"$EXCEL_FILE" \
              -F caption="ðŸ“Š Scraped Screener Data (Excel)"
          fi

      # --- 6. COMMIT RESULTS ---
      - name: Commit updated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Commit results from ALL folders 
          git add -A data/*.parquet results_all/*.csv results_all/*.xlsx results_selected/*.csv
          
          git commit -m "Test Run: Updated Signals & Analysis [skip ci]" || echo "No changes to commit"
          git push
